name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run unit tests
        run: python -m pytest engine/tests/ --ignore=engine/tests/test_api_integration.py -v

      - name: Run API integration tests
        run: python -m pytest engine/tests/test_api_integration.py -v

  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

  # ── Tauri desktop build ──────────────────────────────────────────────────
  # Produces signed/unsigned installers for macOS (arm64) and Windows (x64).
  # Intel macOS (.dmg) can be added by including macos-13 in the matrix.
  #
  # Each runner:
  #   1. Builds the PyInstaller sidecar for that platform.
  #   2. Moves the output to the canonical path (backend/dist/almready-backend)
  #      that tauri.conf.json references as a bundle resource.
  #   3. Runs `cargo tauri build` to produce the final installer.
  #
  # Code signing (optional, configure when ready to distribute):
  #   macOS: set APPLE_CERTIFICATE, APPLE_CERTIFICATE_PASSWORD,
  #          APPLE_SIGNING_IDENTITY, APPLE_ID, APPLE_PASSWORD, APPLE_TEAM_ID
  #          as repository secrets.
  #   Windows: set WINDOWS_CERTIFICATE, WINDOWS_CERTIFICATE_PASSWORD
  #            as repository secrets.
  tauri-build:
    needs: [backend-tests, frontend-build]
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-14       # Apple Silicon (arm64) — M1/M2/M3 Macs
            target: aarch64-apple-darwin
            label: macos-arm64
          - platform: macos-13       # Intel (x64) — older Macs incl. dev machine
            target: x86_64-apple-darwin
            label: macos-x64
          - platform: windows-2022   # x64
            target: x86_64-pc-windows-msvc
            label: windows-x64

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      # ── Python + PyInstaller ──────────────────────────────────────────────
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies (incl. pyinstaller)
        working-directory: backend
        run: pip install -r requirements.txt

      - name: Build PyInstaller sidecar
        working-directory: backend
        run: >
          pyinstaller almready-backend.spec
          --distpath dist/build-${{ matrix.label }}

      # Move to the canonical path tauri.conf.json references.
      - name: Stage sidecar for Tauri bundle (macOS/Linux)
        if: runner.os != 'Windows'
        run: mv backend/dist/build-${{ matrix.label }}/almready-backend backend/dist/almready-backend

      - name: Stage sidecar for Tauri bundle (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Move-Item -Path backend\dist\build-${{ matrix.label }}\almready-backend -Destination backend\dist\almready-backend

      # ── Node (for Vite build inside cargo tauri build) ───────────────────
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install npm dependencies
        run: npm ci

      # ── Rust ─────────────────────────────────────────────────────────────
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust/Cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      # ── Tauri CLI ─────────────────────────────────────────────────────────
      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2" --locked

      # ── macOS signing (only if secrets are configured) ───────────────────
      - name: Import macOS signing certificate
        if: runner.os == 'macOS' && env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          security list-keychains -d user -s build.keychain
          rm certificate.p12

      # ── Build ─────────────────────────────────────────────────────────────
      - name: Build Tauri app
        run: cargo tauri build --target ${{ matrix.target }}
        env:
          # macOS signing (no-ops if secrets are unset)
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # ── Upload artifacts ──────────────────────────────────────────────────
      - name: Upload macOS installer
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ALMReady-${{ matrix.label }}-installer
          path: src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          retention-days: 30

      - name: Upload Windows installer
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ALMReady-${{ matrix.label }}-installer
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
          retention-days: 30
